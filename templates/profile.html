{% extends "layout.html" %}

{% block title %}User Profile{% endblock %}

{% block header_title %}
    <h2>Profile</h2>
{% endblock %}

{% block content %}
<style>
    /* CSS for centering and styling the profile page */
    .profile-page-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding-top: 50px;
    }
    .profile-card {
        background-color: #fff;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-align: center;
        width: 100%;
        max-width: 500px;
    }
    .profile-image-section {
        position: relative;
        width: 150px;
        height: 150px;
        margin: 0 auto 20px auto;
    }
    .profile-image-section img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #f0f0f0;
    }
    #upload-btn {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background-color: #007bff;
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
    }
    .profile-details p {
        font-size: 1.1em;
        margin: 15px 0;
        text-align: left;
    }
    .profile-details input {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        font-size: 1em;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    .edit-mode { display: none; }
    .profile-actions {
        margin-top: 30px;
    }
    .profile-actions button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
    }
    #edit-btn { background-color: #007bff; color: white; }
    #save-btn { background-color: #28a745; color: white; display: none; }
</style>

<div class="profile-page-container">
    <div class="profile-card">
        <div class="profile-image-section">
            <img id="profile-img" src="https://i.stack.imgur.com/34AD2.jpg" alt="Profile Image">
            <input type="file" id="file-input" accept="image/*" style="display: none;">
            <button id="upload-btn" title="Upload new picture"><i class='bx bx-camera'></i></button>
        </div>

        <div class="profile-details">
            <p><strong>Name:</strong>
                <span class="view-mode" id="profile-name">Loading...</span>
                <input type="text" class="edit-mode" id="input-name">
            </p>
            <p><strong>Email:</strong>
                <span class="view-mode" id="profile-email">Loading...</span>
            </p>
            <p><strong>Register Number:</strong>
                <span class="view-mode" id="profile-reg-num">Loading...</span>
                <input type="text" class="edit-mode" id="input-reg-num">
            </p>
            <p><strong>College:</strong>
                <span class="view-mode" id="profile-college">Loading...</span>
                <input type="text" class="edit-mode" id="input-college">
            </p>
        </div>

        <div class="profile-actions">
            <button id="edit-btn">Edit Details</button>
            <button id="save-btn">Save Changes</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const userId = '{{ user_id }}';
        
        // --- DOM Element References ---
        const profileImg = document.getElementById('profile-img');
        const uploadBtn = document.getElementById('upload-btn');
        const fileInput = document.getElementById('file-input');

        const nameSpan = document.getElementById('profile-name');
        const emailSpan = document.getElementById('profile-email');
        const regNumSpan = document.getElementById('profile-reg-num');
        const collegeSpan = document.getElementById('profile-college');

        const nameInput = document.getElementById('input-name');
        const regNumInput = document.getElementById('input-reg-num');
        const collegeInput = document.getElementById('input-college');

        const editBtn = document.getElementById('edit-btn');
        const saveBtn = document.getElementById('save-btn');

        const viewModeElements = document.querySelectorAll('.view-mode');
        const editModeElements = document.querySelectorAll('.edit-mode');

        // 1. Fetch and display initial user data
        fetch(`/api/user/${userId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const userData = data.data;
                    nameSpan.textContent = userData.name;
                    emailSpan.textContent = userData.email;
                    regNumSpan.textContent = userData.registerNumber;
                    collegeSpan.textContent = userData.college;
                    
                    nameInput.value = userData.name;
                    regNumInput.value = userData.registerNumber;
                    collegeInput.value = userData.college;
                    
                    if (userData.profileImageUrl) {
                        profileImg.src = userData.profileImageUrl;
                    }
                } else {
                    console.error('Failed to load user data:', data.message);
                }
            });

        // 2. Toggle between view and edit modes
        editBtn.addEventListener('click', () => {
            viewModeElements.forEach(el => el.style.display = 'none');
            editModeElements.forEach(el => el.style.display = 'block');
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
        });

        // 3. Save updated text data
        saveBtn.addEventListener('click', () => {
            const updatedData = {
                name: nameInput.value,
                registerNumber: regNumInput.value,
                college: collegeInput.value,
            };

            fetch(`/api/user/${userId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Profile updated successfully!');
                    location.reload();
                } else {
                    alert('Error updating profile: ' + data.message);
                }
            });
        });

        // 4. Handle profile image upload with Cloudinary
        uploadBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('profileImage', file);

            profileImg.style.opacity = '0.5';

            fetch(`/api/user/${userId}/upload_image`, {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    profileImg.src = data.imageUrl;
                    document.getElementById('header-profile-pic').src = data.imageUrl;
                    alert('Profile image updated successfully!');
                } else {
                    alert('Error updating image: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Upload Error:', error);
                alert('An error occurred during upload. Please try again.');
            })
            .finally(() => {
                profileImg.style.opacity = '1';
            });
        });
    });
</script>

{% endblock %}